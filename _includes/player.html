<!-- Simple Audio Player -->
<div class="audio-player">
  <div id="now-playing"></div>
  <audio id="audio-player" controls></audio>
  <div class="player-controls">
    <button id="shuffle-button" class="button">Shuffle</button>
  </div>
</div>

<div id="playlist"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const audioPlayer = document.getElementById('audio-player');
    const nowPlaying = document.getElementById('now-playing');
    const playlist = document.getElementById('playlist');

    let allTracks = [];
    let currentTrackIndex = -1;
    let shuffleMode = false;

    fetch('/assets/data/tracks.json')
      .then(response => response.json())
      .then(buildMusicLibrary)
      .catch(error => console.error('Error loading track list:', error));

    function buildMusicLibrary(musicData) {
      organizeTracksByGenre(musicData);
      setupMediaSession();
      audioPlayer.addEventListener('ended', playNextTrack);
    }

    function organizeTracksByGenre(musicData) {
      Object.entries(musicData).forEach(([genre, tracks]) => {
        const genreSection = createGenreSection(genre);
        const trackList = createGenreTrackList(genre, tracks);

        genreSection.appendChild(trackList);
        playlist.appendChild(genreSection);
      });
    }

    function createGenreSection(genre) {
      const details = document.createElement('details');
      const summary = document.createElement('summary');
      summary.textContent = genre;
      details.appendChild(summary);
      return details;
    }

    function createGenreTrackList(genre, tracks) {
      const trackList = document.createElement('ul');

      tracks.forEach(track => {
        allTracks.push({
          ...track,
          genre: genre
        });
        const trackElement = createTrackListItem(track);
        trackList.appendChild(trackElement);
      });

      return trackList;
    }


    function createTrackListItem(track) {
      const trackElement = document.createElement('li');
      trackElement.classList.add('track');
      trackElement.textContent = track.title;
      trackElement.dataset.id = track.id;

      trackElement.addEventListener('click', function () {
        playTrackById(track.id);
      });

      return trackElement;
    }

    // Playback control functions
    function playTrackById(id) {
      currentTrackIndex = allTracks.findIndex(track => track.id === id);
      if (currentTrackIndex === -1) return;

      const track = allTracks[currentTrackIndex];
      document.querySelectorAll('.track').forEach(t => t.classList.remove('active'));
      document.querySelector(`.track[data-id="${id}"]`).classList.add('active');
      const trackPath = `/assets/static/music/${track.genre}/${track.title}.mp3`;
      nowPlaying.textContent = track.title;
      updateMediaSessionMetadata(track);
      audioPlayer.src = trackPath;
      // audioPlayer.load();
      audioPlayer.play();
      audioPlayer.addEventListener('canplay', () => {
        
      }, { once: true });
    }


    function playNextTrack() {
      if (allTracks.length === 0) return;

      let nextIndex;
      if (shuffleMode) {
        // Pick a random track different from the current one
        do {
          nextIndex = Math.floor(Math.random() * allTracks.length);
        } while (nextIndex === currentTrackIndex && allTracks.length > 1);
      } else {
        // Sequential mode
        nextIndex = currentTrackIndex + 1;
        if (nextIndex >= allTracks.length) {
          nextIndex = 0; // Loop back to the first track
        }
      }

      playTrackById(allTracks[nextIndex].id);
    }

    function playPreviousTrack() {
      if (allTracks.length === 0) return;

      let prevIndex = currentTrackIndex - 1;
      if (prevIndex < 0) {
        prevIndex = allTracks.length - 1; // Loop to the last track
      }

      playTrackById(allTracks[prevIndex].id);
    }


    function setupMediaSession() {
      if (!('mediaSession' in navigator)) return;
      navigator.mediaSession.setActionHandler('previoustrack', playPreviousTrack);
      navigator.mediaSession.setActionHandler('nexttrack', playNextTrack);
      navigator.mediaSession.setActionHandler('seekto', function (details) {
        if (details.seekTime !== undefined) {
          audioPlayer.currentTime = details.seekTime;
        }
      });
    }

    // Setup shuffle button
    const shuffleButton = document.getElementById('shuffle-button');
    shuffleButton.addEventListener('click', function() {
      shuffleMode = !shuffleMode;
      this.classList.toggle('active', shuffleMode);
      if (shuffleMode && !audioPlayer.src ) {
        playNextTrack();
      }
    });

    function updateMediaSessionMetadata(track) {
      if (!('mediaSession' in navigator)) return;

      if (!navigator.mediaSession.metadata) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: track?.title,
          artist: '',
          album: '',
          artwork: [{
          src: window.location.origin + `/assets/static/primes.png`,
          sizes: '512x512',
          type: 'image/png'
        }]
      });
      } else {
        navigator.mediaSession.metadata.title = track?.title;
      }
      setupMediaSession();
    }

  });
</script>

<style>
  .audio-player {
    position: sticky;
    top: 0;
    font-size: 0.9rem;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    z-index: 10;
  }

  #audio-player {
    width: 100%;
  }

  #now-playing {
    font-family: "Atkinson Hyperlegible Mono", "Inconsolata", monospace;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    margin-left: 1rem;
    background-color: #1b1c1d;
  }

  .player-controls {
    display: flex;
    justify-content: right;
  }

  .player-controls button {
    background-color: #1b1c1d;
    font-family: "Atkinson Hyperlegible Mono", "Inconsolata", monospace;
    cursor: pointer;
    border: none;
    font-size: 0.9rem;
  }

  #shuffle-button.active {
    color: #FF530D;
  }

  .track {
    cursor: pointer;
  }

  .track:hover {
    text-decoration: underline;
  }

  .track.active {
    color: #FF530D;
  }

  .track-list {
    margin-bottom: 1rem;
  }
</style>