<!-- Simple Audio Player -->
<div class="audio-player">
  <div id="now-playing"></div>
  <audio id="audio-player" controls></audio>
  <br>
</div>

<div id="playlist"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const audioPlayerApp = {
    elements: {
      player: document.getElementById('audio-player'),
      nowPlaying: document.getElementById('now-playing'),
      playlist: document.getElementById('playlist')
    },
    
    currentTrackIndex: -1,
    currentGenre: '',
    flatPlaylist: [],
    
    init: function() {
      this.loadMusicData();
      this.setupEventListeners();
    },
    
    setupEventListeners: function() {
      this.elements.player.addEventListener('ended', () => this.playNextTrack());
    },
    
    loadMusicData: function() {
      fetch('/assets/data/tracks.json')
        .then(response => response.json())
        .then(data => this.buildPlaylist(data))
        .catch(error => {
          console.error('Error loading music data:', error);
          this.elements.playlist.innerHTML = '<p>Failed to load music.</p>';
        });
    },
    
    buildPlaylist: function(data) {
      this.flatPlaylist = [];
      Object.keys(data).forEach(genre => {
        this.createGenreSection(genre, data[genre]);
      });
    },
    
    createGenreSection: function(genre, tracks) {
      // Create details element
      const details = document.createElement('details');
      details.className = 'genre-section';
      // Open first genre by default
      if (this.elements.playlist.childElementCount === 0) {
        details.open = true;
      }
      
      // Create summary with genre title
      const summary = document.createElement('summary');
      summary.textContent = genre;
      details.appendChild(summary);
      
      const tracksList = document.createElement('ul');
      tracksList.className = 'track-list';
      
      tracks.forEach(track => {
        // Add to flat playlist for sequential playback
        this.flatPlaylist.push({ genre, track });
        
        const trackItem = this.createtrackItem(genre, track);
        tracksList.appendChild(trackItem);
      });
      
      details.appendChild(tracksList);
      this.elements.playlist.appendChild(details);
    },
    
    createtrackItem: function(genre, track) {
      const trackItem = document.createElement('li');
      trackItem.textContent = track;
      trackItem.className = 'track';
      
      trackItem.addEventListener('click', () => this.playtrack(genre, track, trackItem));
      
      return trackItem;
    },
    
    playtrack: function(genre, track, trackItem) {
      try {
        const fileName = encodeURIComponent(track + '.mp3');
        this.elements.player.src = `/assets/static/music/${genre.toLowerCase()}/${fileName}`;
        this.elements.nowPlaying.textContent = track;
        
        // Update current track information
        this.currentGenre = genre;
        this.currentTrackIndex = this.flatPlaylist.findIndex(item => 
          item.genre === genre && item.track === track
        );
        
        // Highlight current track
        document.querySelectorAll('#playlist li').forEach(item => {
          item.classList.remove('active');
        });
        trackItem.classList.add('active');
        
        // Set MediaSession metadata for lock screen display
        if ('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: track
          });
        }
        
        // Play the track
        this.elements.player.play().catch(e => {
          console.error('Error playing audio:', e);
          this.elements.nowPlaying.textContent = 'Error playing: ' + track;
        });
      } catch (error) {
        console.error('Error setting up audio:', error);
        this.elements.nowPlaying.textContent = 'Error with: ' + track;
      }
    },
    
    playNextTrack: function() {
      if (this.currentTrackIndex >= 0 && this.flatPlaylist.length > 0) {
        // Remove active class from current track
        document.querySelectorAll('#playlist li.active').forEach(item => {
          item.classList.remove('active');
        });
        
        const nextIndex = (this.currentTrackIndex + 1) % this.flatPlaylist.length;
        const nextTrack = this.flatPlaylist[nextIndex];
        
        // Find the DOM element for this track
        const trackElements = document.querySelectorAll('#playlist li.track');
        let trackElement = null;
        
        for (let i = 0; i < trackElements.length; i++) {
          if (trackElements[i].textContent === nextTrack.track) {
            trackElement = trackElements[i];
            break;
          }
        }
        
        if (trackElement) {
          this.playtrack(nextTrack.genre, nextTrack.track, trackElement);
        }
      }
    }
  };
  
  audioPlayerApp.init();
});
</script>

<style>
  .audio-player {
    position: sticky;
    top: 0;
    font-size: 0.9rem;
  }
  
  #audio-player {
    width: 100%;
  }
  
  #now-playing {
    font-family: "Atkinson Hyperlegible Mono", "Inconsolata", monospace;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    margin-left:1rem;
    background-color: #1b1c1d;
  }

  .track:hover {
    color: #ffc800
  }
  
  .track.active {
    color: #FF530D
  }


</style>